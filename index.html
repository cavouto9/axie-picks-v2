<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Axie Teams Manager</title>
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    background-attachment: fixed;
    color: #fff;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

h1 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 2.5rem;
    font-weight: 800;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    letter-spacing: -0.5px;
    position: relative;
    z-index: 1;
}

.add-team {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 40px;
    position: relative;
    z-index: 1;
}

.add-team input[type="text"] {
    padding: 14px 18px;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.2);
    width: 220px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    color: #fff;
    font-size: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.add-team input[type="text"]::placeholder {
    color: rgba(255,255,255,0.7);
}

.add-team input[type="text"]:focus {
    outline: none;
    border-color: rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.add-team button {
    background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
    color: #667eea;
    font-weight: 700;
    border: none;
    padding: 14px 28px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-size: 15px;
    letter-spacing: 0.3px;
}

.add-team button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
}

.add-team button:active {
    transform: translateY(0);
}

#teamsContainer {
    display: flex;
    flex-direction: column;
    gap: 25px;
    align-items: center;
    position: relative;
    z-index: 1;
}

.team-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    width: 100%;
    max-width: 950px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid rgba(255,255,255,0.2);
}

.team-card:hover {
    transform: translateY(-8px) scale(1.01);
    box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    background: rgba(255,255,255,0.15);
}

.team-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.2);
}

.team-name {
    font-size: 26px;
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    letter-spacing: -0.5px;
}

.team-header button {
    background: rgba(255,255,255,0.2);
    color: #fff;
    font-weight: 600;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    backdrop-filter: blur(10px);
}

.team-header button:hover {
    background: rgba(255,100,100,0.3);
    border-color: rgba(255,100,100,0.5);
    transform: scale(1.05);
}

.axie-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    justify-content: center;
    padding: 10px;
}

.axie-container {
    position: relative;
    cursor: pointer;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 3px solid transparent;
    width: 100%;
    aspect-ratio: 1;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    /* Quitar efectos de focus/touch en m√≥vil */
    outline: none !important;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
}

.axie-container:hover {
    transform: scale(1.1) rotate(2deg);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    z-index: 10;
}

.axie-container:active,
.axie-container:focus {
    outline: none !important;
    /* Sin transformaci√≥n para evitar movimiento en m√≥vil */
    transform: none !important;
    -webkit-transform: none !important;
}

.axie-container:active:focus {
    outline: none !important;
    transform: none !important;
    -webkit-transform: none !important;
}

/* Prevenir cualquier transformaci√≥n no deseada despu√©s del click */
.axie-container:active *,
.axie-container:focus * {
    transform: none !important;
    -webkit-transform: none !important;
}

.axie-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: all 0.3s ease;
    background: transparent;
    /* Prevenir movimiento en m√≥vil */
    -webkit-user-drag: none;
    user-select: none;
    -webkit-user-select: none;
    pointer-events: none; /* La imagen no captura eventos, solo el contenedor */
    transform: none !important;
    -webkit-transform: none !important;
}

.axie-container img.loading {
    opacity: 0.5;
    filter: blur(5px);
}

.axie-container img.error {
    opacity: 0.3;
}

.axie-container.banned {
    border-color: #ff4757;
    opacity: 0.7;
    background: rgba(255, 71, 87, 0.1);
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
}

.axie-container.banned::after {
    content: 'üö´';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    z-index: 5;
    pointer-events: none;
}

.axie-container.picked {
    border-color: #2ed573;
    background: rgba(46, 213, 115, 0.1);
    box-shadow: 0 0 20px rgba(46, 213, 115, 0.4);
    transform: scale(1.05);
}

.axie-container.picked::after {
    content: '‚úì';
    position: absolute;
    top: 8px;
    left: 8px;
    background: #2ed573;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    z-index: 5;
    box-shadow: 0 2px 10px rgba(46, 213, 115, 0.5);
}

.axie-delete {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.95);
    color: #ff4757;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-weight: bold;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 10;
    line-height: 1;
}

.axie-delete:hover {
    background: #ff4757;
    color: white;
    transform: scale(1.2) rotate(90deg);
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5);
}

.add-axie {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid rgba(255,255,255,0.2);
}

.add-axie input {
    padding: 12px 16px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.2);
    width: 180px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    color: #fff;
    font-size: 14px;
    transition: all 0.3s ease;
}

.add-axie input::placeholder {
    color: rgba(255,255,255,0.7);
}

.add-axie input:focus {
    outline: none;
    border-color: rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
}

.add-axie button {
    background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
    color: #667eea;
    font-weight: 700;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.add-axie button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: rgba(255,255,255,0.8);
    font-size: 18px;
}

.status-indicator {
    display: none !important; /* Ocultar completamente el indicador */
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 1000;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    /* Asegurar que no se mueva con el scroll */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

.status-indicator.connected {
    background: rgba(46, 213, 115, 0.3);
    border: 2px solid rgba(46, 213, 115, 0.5);
    color: #2ed573;
}

.status-indicator.disconnected {
    background: rgba(255, 71, 87, 0.3);
    border: 2px solid rgba(255, 71, 87, 0.5);
    color: #ff4757;
    cursor: pointer;
}

.status-indicator.disconnected:hover {
    background: rgba(255, 71, 87, 0.4);
    transform: scale(1.05);
}

.firebase-warning {
    position: fixed;
    top: 70px;
    right: 20px;
    max-width: 350px;
    padding: 15px 20px;
    border-radius: 12px;
    background: rgba(255, 193, 7, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 193, 7, 0.4);
    color: #ffc107;
    font-size: 13px;
    z-index: 999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
}

.firebase-warning strong {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
}

.firebase-warning a {
    color: #ffc107;
    text-decoration: underline;
}

.status-indicator.syncing {
    background: rgba(255, 193, 7, 0.3);
    border: 2px solid rgba(255, 193, 7, 0.5);
    color: #ffc107;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-indicator.connected .status-dot {
    background: #2ed573;
}

.status-indicator.disconnected .status-dot {
    background: #ff4757;
}

.status-indicator.syncing .status-dot {
    background: #ffc107;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(0.8);
    }
}

.realtime-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 12px;
    background: rgba(46, 213, 115, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(46, 213, 115, 0.4);
    color: #2ed573;
    font-weight: 600;
    font-size: 14px;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@media (max-width: 900px) {
    .axie-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 700px) {
    h1 {
        font-size: 2rem;
    }
    
    .axie-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    
    .team-name {
        font-size: 22px;
    }
    
    .add-team input[type="text"] {
        width: 100%;
        max-width: 300px;
    }
}

@media (max-width: 500px) {
    .axie-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .add-axie input {
        width: 140px;
    }
    
    .team-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    /* Ocultar indicador de estado en m√≥vil */
    .status-indicator {
        display: none !important;
    }
    
    /* Prevenir movimiento de im√°genes en m√≥vil */
    .axie-container {
        transform: none !important;
        -webkit-transform: none !important;
    }
    
    .axie-container:active,
    .axie-container:focus,
    .axie-container:active:focus {
        transform: none !important;
        -webkit-transform: none !important;
    }
    
    .axie-container img {
        transform: none !important;
        -webkit-transform: none !important;
        will-change: auto;
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Animaci√≥n de team-card deshabilitada para evitar movimiento de ventana */
/* .team-card { animation: fadeIn 0.5s ease-out; } */
</style>
</head>
<body>

<h1>‚öîÔ∏è Axie Teams Manager</h1>

<div id="statusIndicator" class="status-indicator disconnected">
    <span class="status-dot"></span>
    <span id="statusText">Desconectado</span>
</div>

<div class="add-team">
    <input type="text" id="teamNameInput" placeholder="Nombre del equipo">
    <input type="text" id="axieIdsInput" placeholder="IDs separados por coma">
    <button onclick="addTeam()">‚ûï Agregar equipo</button>
</div>

<div id="teamsContainer"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
// ============================================
// üî• CONFIGURACI√ìN DE FIREBASE PARA TIEMPO REAL
// ============================================
// 
// üìñ INSTRUCCIONES COMPLETAS: Lee el archivo GUIA_FIREBASE.md
//
// PASOS R√ÅPIDOS:
// 1. Ve a https://console.firebase.google.com/
// 2. Crea un proyecto nuevo
// 3. Ve a "Realtime Database" > "Create Database" > "Start in test mode"
// 4. Ve a "Project Settings" (‚öôÔ∏è) > "General" > "Your apps" > √≠cono </> (Web)
// 5. Registra tu app y copia la configuraci√≥n
// 6. Pega los valores aqu√≠ abajo (reemplaza TODO lo que dice "TU_...")
//
// ‚ö†Ô∏è IMPORTANTE: Mant√©n las comillas " alrededor de cada valor
//
// Ejemplo de c√≥mo deber√≠a verse:
// apiKey: "AIzaSyB1234567890abcdefghijklmnopqrstuvwxyz",
// authDomain: "mi-proyecto.firebaseapp.com",
// etc...

const firebaseConfig = {
    apiKey: "AIzaSyCLU9XKBuiZ6QyWRoy1hgN-AG_lYkKDNaA",
    authDomain: "axie-teams-manager.firebaseapp.com",
    databaseURL: "https://axie-teams-manager-default-rtdb.firebaseio.com",
    projectId: "axie-teams-manager",
    storageBucket: "axie-teams-manager.firebasestorage.app",
    messagingSenderId: "90838655104",
    appId: "1:90838655104:web:ba7444a58661f8330b8665"
};

// Inicializar Firebase
let db = null;
let isFirebaseConfigured = false;
let isSyncing = false;
let realtimeListener = null;

// Funci√≥n para verificar si Firebase est√° configurado
function isFirebaseConfigValid() {
    return firebaseConfig.apiKey && 
           firebaseConfig.apiKey !== "TU_API_KEY" &&
           firebaseConfig.apiKey.length > 10 &&
           firebaseConfig.projectId && 
           firebaseConfig.projectId !== "TU_PROJECT_ID" &&
           firebaseConfig.databaseURL && 
           firebaseConfig.databaseURL.includes('firebaseio.com');
}

try {
    if (isFirebaseConfigValid()) {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        isFirebaseConfigured = true;
        updateConnectionStatus('connected');
        console.log('‚úÖ Firebase conectado correctamente');
        console.log('üîÑ Sincronizaci√≥n en tiempo real activada');
    } else {
        console.warn('‚ö†Ô∏è Firebase no configurado correctamente.');
        console.warn('üìñ Lee GUIA_FIREBASE.md para instrucciones completas');
        console.warn('üíæ Usando modo local (localStorage)');
        updateConnectionStatus('disconnected');
        showFirebaseWarning();
    }
} catch (error) {
    console.error('‚ùå Error al inicializar Firebase:', error);
    console.error('üí° Verifica que:');
    console.error('   1. Todas las credenciales est√©n correctamente copiadas');
    console.error('   2. Las comillas " est√©n alrededor de cada valor');
    console.error('   3. La Realtime Database est√© creada en Firebase');
    console.error('   4. Las reglas de seguridad permitan lectura/escritura');
    updateConnectionStatus('disconnected');
    showFirebaseWarning();
}

let teamCount = 0;
const DB_PATH = 'axieTeams';

// Funci√≥n de prueba para verificar conexi√≥n
function testFirebaseConnection() {
    if (!isFirebaseConfigured || !db) {
        console.error('‚ùå Firebase no est√° configurado');
        return;
    }
    
    console.log('üß™ Probando conexi√≥n con Firebase...');
    db.ref(DB_PATH).once('value')
        .then((snapshot) => {
            console.log('‚úÖ Conexi√≥n exitosa!');
            console.log('üìä Datos actuales:', snapshot.val());
        })
        .catch((error) => {
            console.error('‚ùå Error de conexi√≥n:', error);
            console.error('üí° Verifica las reglas de seguridad en Firebase Console');
        });
}

// Exponer funci√≥n de prueba globalmente para debugging
window.testFirebase = testFirebaseConnection;

// Funci√≥n para actualizar el estado de conexi√≥n
function updateConnectionStatus(status) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    indicator.className = `status-indicator ${status}`;
    
    switch(status) {
        case 'connected':
            statusText.textContent = 'üü¢ Conectado';
            break;
        case 'disconnected':
            statusText.textContent = 'üî¥ Modo Local';
            break;
        case 'syncing':
            statusText.textContent = 'üü° Sincronizando...';
            break;
    }
}

// Funci√≥n para mostrar advertencia de Firebase no configurado
function showFirebaseWarning() {
    // Verificar si ya existe el mensaje
    if (document.getElementById('firebaseWarning')) return;
    
    const warning = document.createElement('div');
    warning.id = 'firebaseWarning';
    warning.className = 'firebase-warning';
    warning.innerHTML = `
        <strong>‚ö†Ô∏è Firebase no configurado</strong>
        Est√°s en modo local. Para habilitar sincronizaci√≥n en tiempo real:
        <br><br>
        üìñ Lee <strong>GUIA_FIREBASE.md</strong> para instrucciones paso a paso
        <br><br>
        <a href="https://console.firebase.google.com/" target="_blank">üîó Ir a Firebase Console</a>
    `;
    document.body.appendChild(warning);
    
    // Cerrar al hacer clic
    setTimeout(() => {
        warning.style.cursor = 'pointer';
        warning.onclick = () => warning.remove();
    }, 2000);
}

// Funci√≥n para mostrar notificaci√≥n de cambio en tiempo real
function showRealtimeNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'realtime-notification';
    notification.textContent = `üîÑ ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Obtener datos de equipos desde el DOM
function getTeamsData() {
    const teams = [];
    document.querySelectorAll('.team-card').forEach(teamDiv => {
        const teamId = teamDiv.dataset.teamId;
        const name = teamDiv.querySelector('.team-name').innerText;
        const axies = [];
        teamDiv.querySelectorAll('.axie-container').forEach(axieDiv => {
            const id = axieDiv.dataset.axieId;
            if (!id) return;
            let status = '';
            if(axieDiv.classList.contains('banned')) status = 'banned';
            else if(axieDiv.classList.contains('picked')) status = 'picked';
            axies.push({id, status});
        });
        teams.push({id: teamId, name, axies});
    });
    return teams;
}

// Guardar equipos (localStorage + Firebase)
function saveTeams() {
    const teams = getTeamsData();
    
    // Guardar en localStorage siempre (fallback)
    localStorage.setItem('axieTeams', JSON.stringify(teams));
    
    // Guardar en Firebase si est√° configurado
    if (isFirebaseConfigured && db) {
        // Usar un peque√±o delay para evitar conflictos con el listener
        clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(() => {
            // Solo guardar si no estamos en medio de una actualizaci√≥n desde tiempo real
            if (!isSyncing) {
                isSyncing = true;
                updateConnectionStatus('syncing');
                
                db.ref(DB_PATH).set(teams)
                    .then(() => {
                        console.log('‚úÖ Datos guardados en Firebase');
                        // Resetear flag m√°s r√°pido para permitir que el listener funcione
                        setTimeout(() => {
                            isSyncing = false;
                            updateConnectionStatus('connected');
                        }, 300);
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al guardar en Firebase:', error);
                        isSyncing = false;
                        updateConnectionStatus('connected');
                    });
            } else {
                // Si estamos sincronizando, intentar de nuevo en un momento
                console.log('‚è≥ Esperando a que termine la sincronizaci√≥n...');
                setTimeout(() => {
                    saveTeams();
                }, 500);
            }
        }, 200);
    }
}

// Actualizar solo los elementos que cambiaron (sin re-renderizar todo)
function updateTeamsIncremental(newTeams, isRealtimeUpdate = false) {
    const container = document.getElementById('teamsContainer');
    const currentTeams = Array.from(container.querySelectorAll('.team-card'));
    
    // Si no hay equipos actuales, renderizar todo
    if (currentTeams.length === 0) {
        renderTeams(newTeams, isRealtimeUpdate);
        return;
    }
    
    // Comparar y actualizar solo lo necesario
    newTeams.forEach(newTeam => {
        const teamId = newTeam.id !== undefined ? newTeam.id : newTeam.name;
        const existingTeamDiv = container.querySelector(`.team-card[data-team-id="${teamId}"]`);
        
        if (!existingTeamDiv) {
            // Equipo nuevo - agregarlo sin animaci√≥n
            const teamDiv = createTeamElement(newTeam, teamId);
            container.appendChild(teamDiv);
            return;
        }
        
        // Actualizar nombre si cambi√≥
        const nameElement = existingTeamDiv.querySelector('.team-name');
        if (nameElement && nameElement.innerText !== newTeam.name) {
            nameElement.innerText = newTeam.name;
        }
        
        // Actualizar axies del equipo
        const grid = existingTeamDiv.querySelector('.axie-grid');
        if (grid) {
            const currentAxies = Array.from(grid.querySelectorAll('.axie-container'));
            const currentAxieIds = currentAxies.map(axie => axie.dataset.axieId);
            const newAxieIds = (newTeam.axies || []).map(axie => axie.id).filter(id => id);
            
            // Eliminar axies que ya no est√°n
            currentAxies.forEach(axieDiv => {
                const axieId = axieDiv.dataset.axieId;
                if (!newAxieIds.includes(axieId)) {
                    axieDiv.remove();
                }
            });
            
            // Agregar o actualizar axies
            newTeam.axies.forEach(axie => {
                if (!axie.id) return;
                
                const existingAxie = grid.querySelector(`.axie-container[data-axie-id="${axie.id}"]`);
                
                if (!existingAxie) {
                    // Axie nuevo - agregarlo
                    addAxieToGrid(axie.id, grid, axie.status || '', false);
                } else {
                    // Actualizar estado del axie existente sin re-renderizar
                    existingAxie.classList.remove('banned', 'picked');
                    if (axie.status === 'banned') {
                        existingAxie.classList.add('banned');
                    } else if (axie.status === 'picked') {
                        existingAxie.classList.add('picked');
                    }
                }
            });
        }
    });
    
    // Eliminar equipos que ya no existen
    const newTeamIds = newTeams.map(t => t.id !== undefined ? t.id : t.name);
    currentTeams.forEach(teamDiv => {
        const teamId = teamDiv.dataset.teamId;
        if (!newTeamIds.includes(teamId)) {
            teamDiv.remove();
        }
    });
    
    // Mostrar mensaje si no hay equipos
    if (container.children.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay equipos guardados. ¬°Crea tu primer equipo arriba!</div>';
    }
}

// Crear elemento de equipo (helper function)
function createTeamElement(team, teamId) {
    const teamDiv = document.createElement('div');
    teamDiv.className = 'team-card';
    teamDiv.dataset.teamId = teamId;

    const header = document.createElement('div');
    header.className = 'team-header';
    header.innerHTML = `<span class="team-name">${team.name}</span> <button onclick="deleteTeam(${teamId})">üóëÔ∏è Eliminar equipo</button>`;
    teamDiv.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'axie-grid';

    team.axies.forEach(axie => {
        if (axie.id) {
            addAxieToGrid(axie.id, grid, axie.status || '', false);
        }
    });

    teamDiv.appendChild(grid);

    const addAxieDiv = document.createElement('div');
    addAxieDiv.className = 'add-axie';
    addAxieDiv.innerHTML = `
        <input type="text" placeholder="ID Axie" id="axieInput-${teamId}" onkeypress="if(event.key==='Enter') addAxie(${teamId})">
        <button onclick="addAxie(${teamId})">‚ûï Agregar Axie</button>
    `;
    teamDiv.appendChild(addAxieDiv);
    
    return teamDiv;
}

// Renderizar equipos en el DOM (solo cuando es necesario re-renderizar todo)
function renderTeams(teams, isRealtimeUpdate = false) {
    const container = document.getElementById('teamsContainer');
    
    if (!teams || teams.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay equipos guardados. ¬°Crea tu primer equipo arriba!</div>';
        return;
    }
    
    // Limpiar contenedor
    container.innerHTML = '';
    teamCount = 0;
    
    teams.forEach(team => {
        const currentTeamId = team.id !== undefined ? team.id : teamCount;
        const teamDiv = createTeamElement(team, currentTeamId);
        container.appendChild(teamDiv);
        teamCount = Math.max(teamCount, parseInt(currentTeamId) + 1);
    });
}

// Cargar equipos (desde Firebase o localStorage)
function loadTeams() {
    if (isFirebaseConfigured && db) {
        // Cargar desde Firebase
        updateConnectionStatus('syncing');
        
        db.ref(DB_PATH).once('value')
            .then((snapshot) => {
                const teams = snapshot.val();
                if (teams) {
                    renderTeams(teams);
                    // Guardar en localStorage como backup
                    localStorage.setItem('axieTeams', JSON.stringify(teams));
                } else {
                    // Si Firebase est√° vac√≠o, intentar localStorage
                    const saved = localStorage.getItem('axieTeams');
                    if (saved) {
                        renderTeams(JSON.parse(saved));
                    } else {
                        renderTeams([]);
                    }
                }
                updateConnectionStatus('connected');
                
                // Configurar listener en tiempo real
                setupRealtimeListener();
            })
            .catch((error) => {
                console.error('Error al cargar desde Firebase:', error);
                // Fallback a localStorage
                const saved = localStorage.getItem('axieTeams');
                if (saved) {
                    renderTeams(JSON.parse(saved));
                } else {
                    renderTeams([]);
                }
                updateConnectionStatus('disconnected');
            });
    } else {
        // Cargar desde localStorage
        const saved = localStorage.getItem('axieTeams');
        if (saved) {
            renderTeams(JSON.parse(saved));
        } else {
            renderTeams([]);
        }
    }
}

// Configurar listener en tiempo real
function setupRealtimeListener() {
    if (!isFirebaseConfigured || !db) {
        console.warn('‚ö†Ô∏è No se puede configurar el listener: Firebase no est√° configurado');
        return;
    }
    
    // Remover listener anterior si existe
    if (realtimeListener) {
        db.ref(DB_PATH).off('value', realtimeListener);
    }
    
    console.log('üîÑ Configurando listener en tiempo real...');
    
    // Variable para rastrear el √∫ltimo timestamp de actualizaci√≥n
    let lastUpdateTime = Date.now();
    
    // Crear nuevo listener
    realtimeListener = db.ref(DB_PATH).on('value', (snapshot) => {
        const teams = snapshot.val();
        const now = Date.now();
        
        // Solo procesar si han pasado al menos 200ms desde la √∫ltima actualizaci√≥n
        if (now - lastUpdateTime < 200) {
            return;
        }
        
        // Comparar con los datos actuales para evitar actualizaciones innecesarias
        // Normalizar los datos para comparaci√≥n (ordenar por ID y limpiar)
        const normalizeData = (data) => {
            return JSON.stringify(
                (data || []).map(team => ({
                    id: team.id,
                    name: team.name,
                    axies: (team.axies || []).map(axie => ({
                        id: axie.id,
                        status: axie.status || ''
                    })).sort((a, b) => a.id.localeCompare(b.id))
                })).sort((a, b) => String(a.id || '').localeCompare(String(b.id || '')))
            );
        };
        
        const currentData = normalizeData(getTeamsData());
        const newData = normalizeData(teams);
        
        // Solo actualizar si los datos son diferentes
        if (currentData !== newData) {
            // Si estamos sincronizando, esperar un poco m√°s
            if (isSyncing) {
                console.log('‚è≥ Esperando a que termine la sincronizaci√≥n local...');
                setTimeout(() => {
                    // Reintentar despu√©s de un delay
                    const retryData = normalizeData(getTeamsData());
                    const retryNewData = normalizeData(teams);
                    if (retryData !== retryNewData && !isSyncing) {
                        isSyncing = true;
                        updateTeamsIncremental(teams || [], true);
                        localStorage.setItem('axieTeams', JSON.stringify(teams || []));
                        setTimeout(() => { isSyncing = false; }, 300);
                    }
                }, 600);
                return;
            }
            
            console.log('üîÑ Cambio detectado en tiempo real');
            console.log('üìä Datos actuales:', currentData.length, 'caracteres');
            console.log('üìä Datos nuevos:', newData.length, 'caracteres');
            
            isSyncing = true;
            lastUpdateTime = now;
            
            // Actualizar solo los elementos que cambiaron (sin re-renderizar todo)
            updateTeamsIncremental(teams || [], true);
            
            // Actualizar localStorage
            localStorage.setItem('axieTeams', JSON.stringify(teams || []));
            
            // Resetear flag despu√©s de un delay
            setTimeout(() => {
                isSyncing = false;
            }, 400);
        }
    }, (error) => {
        console.error('‚ùå Error en el listener de Firebase:', error);
        updateConnectionStatus('disconnected');
    });
    
    console.log('‚úÖ Listener en tiempo real configurado correctamente');
}

// Agregar equipo nuevo
function addTeam() {
    const teamName = document.getElementById('teamNameInput').value.trim();
    const axieIdsRaw = document.getElementById('axieIdsInput').value.trim();
    if(!teamName) { 
        alert("‚ö†Ô∏è Agrega un nombre de equipo"); 
        return; 
    }

    const axieIds = axieIdsRaw ? axieIdsRaw.split(/[\s,]+/).filter(id => id.trim()).slice(0,10) : [];
    const container = document.getElementById('teamsContainer');
    
    // Limpiar mensaje de estado vac√≠o si existe
    if (container.querySelector('.empty-state')) {
        container.innerHTML = '';
    }

    const teamDiv = document.createElement('div');
    teamDiv.className = 'team-card';
    teamDiv.dataset.teamId = teamCount;

    const header = document.createElement('div');
    header.className = 'team-header';
    header.innerHTML = `<span class="team-name">${teamName}</span> <button onclick="deleteTeam(${teamCount})">üóëÔ∏è Eliminar equipo</button>`;
    teamDiv.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'axie-grid';

    axieIds.forEach(id => {
        const trimmedId = id.trim();
        if (trimmedId) {
            addAxieToGrid(trimmedId, grid);
        }
    });

    teamDiv.appendChild(grid);

    const addAxieDiv = document.createElement('div');
    addAxieDiv.className = 'add-axie';
    addAxieDiv.innerHTML = `
        <input type="text" placeholder="ID Axie" id="axieInput-${teamCount}" onkeypress="if(event.key==='Enter') addAxie(${teamCount})">
        <button onclick="addAxie(${teamCount})">‚ûï Agregar Axie</button>
    `;
    teamDiv.appendChild(addAxieDiv);

    container.appendChild(teamDiv);

    teamCount++;
    document.getElementById('teamNameInput').value = '';
    document.getElementById('axieIdsInput').value = '';

    saveTeams();
}

// Agregar un axie a la cuadr√≠cula
function addAxieToGrid(id, grid, status='', shouldSave = true) {
    if(grid.children.length >= 10) { 
        if (shouldSave) alert("‚ö†Ô∏è M√°ximo 10 Axies por equipo"); 
        return; 
    }
    
    // Verificar si el axie ya existe en este grid
    const existingAxies = Array.from(grid.querySelectorAll('.axie-container'));
    if (existingAxies.some(axie => axie.dataset.axieId === id)) {
        if (shouldSave) alert("‚ö†Ô∏è Este Axie ya est√° en el equipo");
        return;
    }
    
    const axieDiv = document.createElement('div');
    axieDiv.className = 'axie-container';
    axieDiv.dataset.axieId = id; // Guardar el ID directamente en el atributo data
    if(status) axieDiv.classList.add(status);

    const img = document.createElement('img');
    img.src = `https://axiecdn.axieinfinity.com/axies/${id}/axie/axie-full-transparent.png`;
    img.alt = `Axie ${id}`;
    img.className = 'loading';
    
    // Manejar carga de imagen
    img.onload = () => {
        img.classList.remove('loading');
        img.classList.remove('error');
    };
    
    img.onerror = () => {
        img.classList.remove('loading');
        img.classList.add('error');
        // Intentar con URL alternativa
        const altImg = new Image();
        altImg.src = `https://assets.axieinfinity.com/axies/${id}/axie/axie-full-transparent.png`;
        altImg.onload = () => {
            img.src = altImg.src;
            img.classList.remove('error');
        };
    };

    axieDiv.addEventListener('click', (e) => {
        // Prevenir comportamiento por defecto
        e.preventDefault();
        e.stopPropagation();
        
        // Quitar focus inmediatamente antes de hacer cambios
        axieDiv.blur();
        if (document.activeElement) {
            document.activeElement.blur();
        }
        
        // Forzar quitar focus de cualquier elemento
        if (document.activeElement && document.activeElement !== document.body) {
            document.activeElement.blur();
        }
        
        // Marcar que este cambio viene del usuario (no de tiempo real)
        const wasBanned = axieDiv.classList.contains('banned');
        const wasPicked = axieDiv.classList.contains('picked');
        
        if(wasBanned) {
            axieDiv.classList.remove('banned');
            axieDiv.classList.add('picked');
        } else if(wasPicked) {
            axieDiv.classList.remove('picked');
        } else {
            axieDiv.classList.add('banned');
        }
        
        // Resetear cualquier transformaci√≥n que pueda quedar
        axieDiv.style.transform = '';
        axieDiv.style.webkitTransform = '';
        
        // Quitar focus nuevamente despu√©s de los cambios
        setTimeout(() => {
            axieDiv.blur();
            if (document.activeElement) {
                document.activeElement.blur();
            }
            // Forzar que el body tenga el focus
            if (document.body) {
                document.body.focus();
            }
        }, 50);
        
        // SIEMPRE guardar cuando el usuario hace cambios (no cuando viene de tiempo real)
        // Usar setTimeout para evitar conflictos con el listener
        setTimeout(() => {
            saveTeams();
        }, 100);
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'axie-delete';
    deleteBtn.innerText = '√ó';
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        axieDiv.style.transition = 'all 0.3s ease';
        axieDiv.style.transform = 'scale(0) rotate(180deg)';
        axieDiv.style.opacity = '0';
        setTimeout(() => {
            axieDiv.remove();
            // SIEMPRE guardar cuando el usuario elimina (no cuando viene de tiempo real)
            setTimeout(() => {
                saveTeams();
            }, 100);
        }, 300);
    };

    axieDiv.appendChild(img);
    axieDiv.appendChild(deleteBtn);
    grid.appendChild(axieDiv);
    
    if (shouldSave) saveTeams();
}

// Agregar axie desde input
function addAxie(teamId) {
    const input = document.getElementById(`axieInput-${teamId}`);
    const id = input.value.trim();
    if(!id) return;
    const teamDiv = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
    const grid = teamDiv.querySelector('.axie-grid');
    addAxieToGrid(id, grid);
    input.value = '';
}

// Eliminar equipo completo
function deleteTeam(teamId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este equipo?')) {
        return;
    }
    const container = document.getElementById('teamsContainer');
    const teamDiv = container.querySelector(`.team-card[data-team-id="${teamId}"]`);
    if(teamDiv) {
        teamDiv.style.transition = 'all 0.4s ease';
        teamDiv.style.transform = 'translateX(-100%)';
        teamDiv.style.opacity = '0';
        setTimeout(() => {
            teamDiv.remove();
            // Guardar inmediatamente despu√©s de eliminar
            setTimeout(() => {
                saveTeams();
            }, 100);
            // Mostrar mensaje de estado vac√≠o si no hay equipos
            if (container.children.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay equipos guardados. ¬°Crea tu primer equipo arriba!</div>';
            }
        }, 400);
    }
}

// Cargar equipos al inicio
loadTeams();
</script>

</body>
</html>
