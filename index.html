<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.3, user-scalable=yes">
    <title>Axie Teams Manager</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/LDM0FH3M/favicon.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/LDM0FH3M/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Modern Palette - Dark Mode (Default) */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-card-hover: rgba(51, 65, 85, 0.8);
            --bg-input: rgba(15, 23, 42, 0.6);
            --bg-input-focus: rgba(15, 23, 42, 0.8);
            --bg-axie-container: rgba(51, 65, 85, 0.4);

            /* Gradients & Accents */
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --primary-gradient-hover: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --accent-color: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.5);

            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;

            /* Borders & Shadows */
            --border-color: rgba(148, 163, 184, 0.1);
            --border-hover: rgba(148, 163, 184, 0.3);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.05);

            /* Status Colors */
            --status-success: #10b981;
            --status-error: #ef4444;
            --status-warning: #f59e0b;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: rgba(255, 255, 255, 0.8);
            --bg-card-hover: rgba(255, 255, 255, 0.95);
            --bg-input: rgba(241, 245, 249, 0.8);
            --bg-input-focus: #ffffff;
            --bg-axie-container: rgba(241, 245, 249, 0.6);

            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;

            --border-color: rgba(0, 0, 0, 0.05);
            --border-hover: rgba(0, 0, 0, 0.1);
            --glass-border: 1px solid rgba(0, 0, 0, 0.05);

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.12);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.08) 0%, transparent 25%);
            background-attachment: fixed;
        }

        body.login-required .main-content {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 3rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
            filter: drop-shadow(0 4px 20px rgba(99, 102, 241, 0.2));
        }

        /* Inputs & Forms */
        input[type="text"],
        input[type="password"] {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            background: var(--bg-input-focus);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        /* Buttons */
        button {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Primary Action Buttons */
        .add-team button,
        .login-form button[type="submit"],
        .add-axie button:not(.copy-ids-btn) {
            background: var(--primary-gradient);
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            /* Pill shape */
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            font-size: 0.95rem;
        }

        .add-team button:hover,
        .login-form button[type="submit"]:hover,
        .add-axie button:not(.copy-ids-btn):hover {
            background: var(--primary-gradient-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .add-team button:active {
            transform: translateY(0);
        }

        /* Secondary/Utility Buttons */
        .theme-toggle {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: 9999px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        /* Add Team Section */
        .add-team {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 60px;
            flex-wrap: wrap;
            background: var(--bg-card);
            padding: 24px;
            border-radius: 24px;
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            box-shadow: var(--shadow-lg);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .add-team input {
            min-width: 250px;
        }

        /* Teams Grid */
        #teamsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 30px;
            padding-bottom: 40px;
        }

        /* Team Card */
        .team-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 24px;
            border: var(--glass-border);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .team-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
        }

        /* Team Header */
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .team-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .team-buttons {
            display: flex;
            gap: 8px;
        }

        .team-buttons button {
            background: transparent;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid transparent;
        }

        .team-buttons button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .team-buttons button.clear-axies-btn:hover {
            color: var(--status-warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .team-buttons button:last-child:hover {
            /* Delete button */
            color: var(--status-error);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Axie Grid */
        .axie-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .axie-container {
            background: var(--bg-axie-container);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
        }

        .axie-container:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
        }

        .axie-image-wrapper {
            flex: 1;
            min-height: 0;
            /* Crucial for flex containers */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            overflow: hidden;
        }

        .axie-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            max-height: 140px;
            /* Limit image height to leave room for ID */
        }

        .axie-container:hover .axie-image-wrapper img {
            transform: scale(1.1);
        }

        .axie-id-label {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            padding: 8px 0;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            /* Prevent shrinking */
            z-index: 2;
            position: relative;
            width: 100%;
            min-height: 32px;
            /* Ensure minimum height */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Axie Status States */
        .axie-container.picked {
            border-color: var(--status-success);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .axie-container.picked::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--status-success);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .axie-container.banned {
            border-color: var(--status-error);
            opacity: 0.7;
            filter: grayscale(0.5);
        }

        .axie-container.banned::after {
            content: '‚úï';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: var(--status-error);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Add Axie Footer */
        .add-axie {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .add-axie input {
            flex: 1;
            min-width: 120px;
            font-size: 0.85rem;
            padding: 8px 12px;
        }

        .add-axie button {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .add-axie .copy-ids-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 8px;
        }

        .add-axie .copy-ids-btn:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(16px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            background: var(--bg-card);
            border: var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            /* Restore original-ish width but responsive */
            position: relative;
            z-index: 10000;
            display: flex;
            flex-direction: column;
        }

        .login-container h2 {
            font-size: 2rem;
            margin-bottom: 32px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-form {
            gap: 24px;
        }

        /* Status Indicator */
        .status-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none !important;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
        }

        .status-indicator.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--status-success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--status-error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            #teamsContainer {
                grid-template-columns: 1fr;
            }

            .team-card {
                max-width: 800px;
                margin: 0 auto;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .add-team {
                flex-direction: column;
                padding: 20px;
            }

            .add-team input {
                width: 100%;
            }

            .add-team button {
                width: 100%;
            }

            .axie-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 480px) {
            .axie-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .team-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .team-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .team-buttons button {
                flex: 1;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="login-required">

    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2>üîê Iniciar Sesi√≥n</h2>
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-error" id="loginError">
                    ‚ö†Ô∏è Usuario o contrase√±a incorrectos
                </div>
                <input type="text" id="usernameInput" placeholder="Usuario" required autocomplete="username">
                <input type="password" id="passwordInput" placeholder="Contrase√±a" required
                    autocomplete="current-password">
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <span>Recordar contrase√±a</span>
                </label>
                <button type="submit">Ingresar</button>
            </form>
        </div>
    </div>

    <div class="main-content">
        <h1>‚öîÔ∏è Axie Teams Manager</h1>

        <div id="statusIndicator" class="status-indicator disconnected">
            <span class="status-dot"></span>
            <span id="statusText">Desconectado</span>
        </div>

        <div class="add-team">
            <input type="text" id="teamNameInput" placeholder="Nombre del equipo">
            <input type="text" id="axieIdsInput" placeholder="IDs separados por coma">
            <button onclick="addTeam()">‚ûï Agregar equipo</button>
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar tema">
                <span class="theme-toggle-icon" id="themeIcon">üåô</span>
                <span id="themeText">Modo Oscuro</span>
            </button>
        </div>

        <div id="teamsContainer"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Bloquear clic derecho y herramientas de desarrollador
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            return false;
        });

        document.addEventListener('keydown', function (e) {
            // Bloquear F12
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+Shift+I (Inspeccionar)
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+Shift+J (Consola)
            if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+Shift+C (Selector de elementos)
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+U (Ver c√≥digo fuente)
            if (e.ctrlKey && e.key === 'U') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+S (Guardar p√°gina)
            if (e.ctrlKey && e.key === 'S') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+P (Imprimir)
            if (e.ctrlKey && e.key === 'P') {
                e.preventDefault();
                return false;
            }
            // Bloquear Ctrl+Shift+K (Consola en Firefox)
            if (e.ctrlKey && e.shiftKey && e.key === 'K') {
                e.preventDefault();
                return false;
            }
        });

        // Bloquear selecci√≥n de texto (opcional, pero puede ayudar)
        document.addEventListener('selectstart', function (e) {
            e.preventDefault();
            return false;
        });

        // Bloquear arrastrar y soltar
        document.addEventListener('dragstart', function (e) {
            e.preventDefault();
            return false;
        });

        function hashPassword(str) {
            let hash = 0;
            if (str.length === 0) return hash.toString();
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36) + str.length.toString(36);
        }

        const _0x1a2b = ['enfermo', 'mental'];
        const _0x3c4d = btoa('admin').split('').reverse().join('');
        const AUTH_DATA = {
            u: _0x3c4d,
            p: hashPassword(_0x1a2b[0] + _0x1a2b[1])
        };

        function decodeUsername(encoded) {
            try {
                return atob(encoded.split('').reverse().join(''));
            } catch {
                return '';
            }
        }

        const LOGIN_CREDENTIALS = {
            username: decodeUsername(AUTH_DATA.u),
            passwordHash: AUTH_DATA.p
        };

        function checkLogin() {
            const remembered = localStorage.getItem('rememberLogin');
            const savedUsername = localStorage.getItem('savedUsername');
            const savedPassword = localStorage.getItem('savedPassword');

            if (remembered === 'true' && savedUsername && savedPassword) {
                const usernameMatch = savedUsername === LOGIN_CREDENTIALS.username;
                const passwordMatch = hashPassword(savedPassword) === LOGIN_CREDENTIALS.passwordHash;

                if (usernameMatch && passwordMatch) {
                    showMainContent();
                    return true;
                } else {
                    localStorage.removeItem('rememberLogin');
                    localStorage.removeItem('savedUsername');
                    localStorage.removeItem('savedPassword');
                }
            }

            showLogin();
            return false;
        }

        function showLogin() {
            document.body.classList.add('login-required');
            const overlay = document.getElementById('loginOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }

            const remembered = localStorage.getItem('rememberLogin');
            if (remembered === 'true') {
                const savedUsername = localStorage.getItem('savedUsername');
                const savedPassword = localStorage.getItem('savedPassword');
                if (savedUsername) {
                    document.getElementById('usernameInput').value = savedUsername;
                }
                if (savedPassword) {
                    document.getElementById('passwordInput').value = savedPassword;
                }
                document.getElementById('rememberMe').checked = true;
            }

            document.getElementById('usernameInput').focus();
        }

        function showMainContent() {
            document.body.classList.remove('login-required');
            const overlay = document.getElementById('loginOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }

            function initializeContent() {
                const teamsContainer = document.getElementById('teamsContainer');
                if (!teamsContainer) {
                    console.warn('‚ö†Ô∏è teamsContainer no encontrado, reintentando...');
                    setTimeout(initializeContent, 100);
                    return;
                }

                if (typeof loadTeams === 'function') {
                    console.log('üîÑ Cargando equipos...');
                    loadTeams();
                } else {
                    console.warn('‚ö†Ô∏è loadTeams no est√° definida, reintentando...');
                    setTimeout(initializeContent, 100);
                    return;
                }
            }

            setTimeout(initializeContent, 150);
        }

        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorDiv = document.getElementById('loginError');

            const usernameMatch = username === LOGIN_CREDENTIALS.username;
            const passwordMatch = hashPassword(password) === LOGIN_CREDENTIALS.passwordHash;

            if (usernameMatch && passwordMatch) {
                if (rememberMe) {
                    localStorage.setItem('rememberLogin', 'true');
                    localStorage.setItem('savedUsername', username);
                    localStorage.setItem('savedPassword', password);
                } else {
                    localStorage.removeItem('rememberLogin');
                    localStorage.removeItem('savedUsername');
                    localStorage.removeItem('savedPassword');
                }

                errorDiv.classList.remove('show');
                showMainContent();
            } else {
                errorDiv.classList.add('show');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();

                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        }

        function updateThemeUI(theme) {
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            if (themeIcon && themeText) {
                if (theme === 'light') {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Modo Claro';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Modo Oscuro';
                }
            }
        }

        initTheme();

        const firebaseConfig = {
            apiKey: "AIzaSyCLU9XKBuiZ6QyWRoy1hgN-AG_lYkKDNaA",
            authDomain: "axie-teams-manager.firebaseapp.com",
            databaseURL: "https://axie-teams-manager-default-rtdb.firebaseio.com",
            projectId: "axie-teams-manager",
            storageBucket: "axie-teams-manager.firebasestorage.app",
            messagingSenderId: "90838655104",
            appId: "1:90838655104:web:ba7444a58661f8330b8665"
        };

        let db = null;
        let isFirebaseConfigured = false;
        let isSyncing = false;
        let realtimeListener = null;
        let lastSaveTime = 0;
        let pendingSave = false;
        let saveQueue = []; // Cola para asegurar que los cambios se guarden en orden
        let isSaving = false; // Flag para saber si estamos guardando actualmente

        function isFirebaseConfigValid() {
            return firebaseConfig.apiKey &&
                firebaseConfig.apiKey !== "TU_API_KEY" &&
                firebaseConfig.apiKey.length > 10 &&
                firebaseConfig.projectId &&
                firebaseConfig.projectId !== "TU_PROJECT_ID" &&
                firebaseConfig.databaseURL &&
                firebaseConfig.databaseURL.includes('firebaseio.com');
        }

        try {
            if (isFirebaseConfigValid()) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                isFirebaseConfigured = true;
                updateConnectionStatus('connected');
                console.log('‚úÖ Firebase conectado correctamente');
                console.log('üîÑ Sincronizaci√≥n en tiempo real activada');
            } else {
                console.warn('‚ö†Ô∏è Firebase no configurado correctamente.');
                console.warn('üìñ Lee GUIA_FIREBASE.md para instrucciones completas');
                console.warn('üíæ Usando modo local (localStorage)');
                updateConnectionStatus('disconnected');
                showFirebaseWarning();
            }
        } catch (error) {
            console.error('‚ùå Error al inicializar Firebase:', error);
            console.error('üí° Verifica que:');
            console.error('   1. Todas las credenciales est√©n correctamente copiadas');
            console.error('   2. Las comillas " est√©n alrededor de cada valor');
            console.error('   3. La Realtime Database est√© creada en Firebase');
            console.error('   4. Las reglas de seguridad permitan lectura/escritura');
            updateConnectionStatus('disconnected');
            showFirebaseWarning();
        }

        let teamCount = 0;
        const DB_PATH = 'axieTeams';

        function testFirebaseConnection() {
            if (!isFirebaseConfigured || !db) {
                console.error('‚ùå Firebase no est√° configurado');
                return;
            }

            console.log('üß™ Probando conexi√≥n con Firebase...');
            db.ref(DB_PATH).once('value')
                .then((snapshot) => {
                    console.log('‚úÖ Conexi√≥n exitosa!');
                    console.log('üìä Datos actuales:', snapshot.val());
                })
                .catch((error) => {
                    console.error('‚ùå Error de conexi√≥n:', error);
                    console.error('üí° Verifica las reglas de seguridad en Firebase Console');
                });
        }

        window.testFirebase = testFirebaseConnection;

        function updateConnectionStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = `status-indicator ${status}`;

            switch (status) {
                case 'connected':
                    statusText.textContent = 'üü¢ Conectado';
                    break;
                case 'disconnected':
                    statusText.textContent = 'üî¥ Modo Local';
                    break;
                case 'syncing':
                    statusText.textContent = 'üü° Sincronizando...';
                    break;
            }
        }

        function showFirebaseWarning() {
            if (document.getElementById('firebaseWarning')) return;

            const warning = document.createElement('div');
            warning.id = 'firebaseWarning';
            warning.className = 'firebase-warning';
            warning.innerHTML = `
        <strong>‚ö†Ô∏è Firebase no configurado</strong>
        Est√°s en modo local. Para habilitar sincronizaci√≥n en tiempo real:
        <br><br>
        üìñ Lee <strong>GUIA_FIREBASE.md</strong> para instrucciones paso a paso
        <br><br>
        <a href="https://console.firebase.google.com/" target="_blank">üîó Ir a Firebase Console</a>
    `;
            document.body.appendChild(warning);

            setTimeout(() => {
                warning.style.cursor = 'pointer';
                warning.onclick = () => warning.remove();
            }, 2000);
        }

        function showRealtimeNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'realtime-notification';
            notification.textContent = `üîÑ ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function getTeamsData() {
            const teams = [];
            const container = document.getElementById('teamsContainer');
            if (!container) return teams;

            const teamCards = Array.from(container.children).filter(child => child.classList.contains('team-card'));

            teamCards.forEach(teamDiv => {
                const teamId = teamDiv.dataset.teamId;
                const nameElement = teamDiv.querySelector('.team-name');
                if (!nameElement) return;

                const name = nameElement.innerText || nameElement.textContent || '';
                const axies = [];
                const axieContainers = teamDiv.querySelectorAll('.axie-container');
                axieContainers.forEach(axieDiv => {
                    const id = axieDiv.dataset.axieId;
                    if (!id) return;
                    let status = '';
                    if (axieDiv.classList.contains('banned')) status = 'banned';
                    else if (axieDiv.classList.contains('picked')) status = 'picked';
                    axies.push({ id: String(id), status: status });
                });
                teams.push({ id: String(teamId), name: name, axies: axies });
            });
            return teams;
        }

        function saveTeams(immediate = false) {
            // No guardar si estamos sincronizando desde Firebase (a menos que sea inmediato)
            if (isSyncing && !immediate) {
                // Agregar a la cola para guardar despu√©s
                saveQueue.push({ immediate: false, timestamp: Date.now() });
                return;
            }

            // Si ya estamos guardando, agregar a la cola
            if (isSaving) {
                saveQueue.push({ immediate: immediate, timestamp: Date.now() });
                return;
            }

            // Leer el estado actual del DOM (m√°s reciente)
            const teams = getTeamsData();
            const now = Date.now();

            localStorage.setItem('axieTeams', JSON.stringify(teams));

            if (isFirebaseConfigured && db) {
                lastSaveTime = now;
                pendingSave = true;
                isSaving = true;

                clearTimeout(window.saveTimeout);

                const saveToFirebase = () => {
                    // Leer el estado M√ÅS RECIENTE del DOM antes de guardar
                    const currentTeams = getTeamsData();

                    // Verificar nuevamente antes de guardar
                    if (isSyncing && !immediate) {
                        isSaving = false;
                        processSaveQueue();
                        return;
                    }

                    pendingSave = false;
                    isSyncing = true;
                    updateConnectionStatus('syncing');

                    db.ref(DB_PATH).set(currentTeams)
                        .then(() => {
                            lastSaveTime = Date.now();
                            // Reducir el tiempo de espera para permitir actualizaciones m√°s r√°pidas
                            setTimeout(() => {
                                isSyncing = false;
                                isSaving = false;
                                updateConnectionStatus('connected');
                                // Procesar la cola despu√©s de guardar
                                processSaveQueue();
                            }, 200);
                        })
                        .catch((error) => {
                            console.error('‚ùå Error al guardar en Firebase:', error);
                            isSyncing = false;
                            isSaving = false;
                            updateConnectionStatus('connected');
                            // Procesar la cola incluso si hay error
                            processSaveQueue();
                        });
                };

                if (immediate) {
                    // Para guardados inmediatos, agregar un peque√±o delay para asegurar que el DOM est√© actualizado
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            saveToFirebase();
                        }, 100);
                    });
                } else {
                    // Para guardados no inmediatos, usar un delay m√°s largo
                    window.saveTimeout = setTimeout(saveToFirebase, 300);
                }
            } else {
                isSaving = false;
            }
        }

        function processSaveQueue() {
            if (saveQueue.length === 0 || isSaving || isSyncing) {
                return;
            }

            // Procesar el siguiente elemento de la cola
            const nextSave = saveQueue.shift();
            if (nextSave) {
                // Delay m√°s largo para asegurar que el DOM se actualice completamente
                // y que cualquier cambio pendiente se refleje antes de guardar
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        saveTeams(nextSave.immediate);
                    }, 200);
                });
            }
        }

        function updateTeamsIncremental(newTeams, isRealtimeUpdate = false) {
            const container = document.getElementById('teamsContainer');
            const currentTeams = Array.from(container.querySelectorAll('.team-card'));

            if (currentTeams.length === 0) {
                renderTeams(newTeams, isRealtimeUpdate);
                return;
            }

            const currentOrder = currentTeams.map(card => card.dataset.teamId);
            const newOrder = newTeams.map(t => String(t.id !== undefined ? t.id : t.name));

            const orderChanged = JSON.stringify(currentOrder) !== JSON.stringify(newOrder);

            if (orderChanged && isRealtimeUpdate) {
                const teamMap = new Map();
                currentTeams.forEach(teamDiv => {
                    teamMap.set(teamDiv.dataset.teamId, teamDiv);
                });

                newOrder.forEach((teamId, index) => {
                    const teamDiv = teamMap.get(teamId);
                    if (teamDiv) {
                        const currentIndex = Array.from(container.children).indexOf(teamDiv);
                        if (currentIndex !== index) {
                            const targetElement = container.children[index];
                            if (targetElement) {
                                container.insertBefore(teamDiv, targetElement);
                            } else {
                                container.appendChild(teamDiv);
                            }
                        }
                    }
                });
            }

            newTeams.forEach((newTeam, teamIndex) => {
                const teamId = String(newTeam.id !== undefined ? newTeam.id : newTeam.name);
                const existingTeamDiv = container.querySelector(`.team-card[data-team-id="${teamId}"]`);

                if (!existingTeamDiv) {
                    const teamDiv = createTeamElement(newTeam, teamId);
                    const insertIndex = newOrder.indexOf(teamId);
                    const currentChildren = Array.from(container.children).filter(c => c.classList.contains('team-card'));
                    if (insertIndex >= 0 && insertIndex < currentChildren.length) {
                        container.insertBefore(teamDiv, currentChildren[insertIndex]);
                    } else {
                        container.appendChild(teamDiv);
                    }
                    return;
                }

                const nameElement = existingTeamDiv.querySelector('.team-name');
                if (nameElement) {
                    const currentName = nameElement.innerText || nameElement.textContent || '';
                    const newName = String(newTeam.name || '');
                    if (currentName !== newName) {
                        nameElement.innerText = newName;
                    }
                }

                const grid = existingTeamDiv.querySelector('.axie-grid');
                if (grid) {
                    const currentAxies = Array.from(grid.querySelectorAll('.axie-container'));
                    const currentAxieIds = currentAxies.map(axie => String(axie.dataset.axieId || ''));
                    const newAxieIds = (newTeam.axies || []).map(axie => String(axie.id || '')).filter(id => id);

                    // Primero, eliminar axies que ya no est√°n en el nuevo estado
                    currentAxies.forEach(axieDiv => {
                        const axieId = String(axieDiv.dataset.axieId || '');
                        if (!newAxieIds.includes(axieId)) {
                            axieDiv.remove();
                        }
                    });

                    // Luego, agregar o actualizar axies del nuevo estado
                    // Ordenar los axies nuevos para mantener consistencia
                    const sortedNewAxies = [...(newTeam.axies || [])].sort((a, b) => {
                        const idA = String(a.id || '');
                        const idB = String(b.id || '');
                        return idA.localeCompare(idB);
                    });

                    sortedNewAxies.forEach(axie => {
                        const axieId = String(axie.id || '');
                        if (!axieId) return;

                        const existingAxie = grid.querySelector(`.axie-container[data-axie-id="${axieId}"]`);

                        if (!existingAxie) {
                            // Agregar nuevo axie
                            addAxieToGrid(axieId, grid, String(axie.status || ''), false);
                        } else {
                            const currentLocalStatus = existingAxie.classList.contains('banned') ? 'banned' :
                                existingAxie.classList.contains('picked') ? 'picked' : '';
                            const newRemoteStatus = String(axie.status || '');

                            if (currentLocalStatus !== newRemoteStatus) {
                                const lastStatusChange = existingAxie.dataset.lastStatusChange ? parseInt(existingAxie.dataset.lastStatusChange) : 0;
                                const timeSinceLastChange = Date.now() - lastStatusChange;
                                const timeSinceLastSave = Date.now() - lastSaveTime;

                                // L√≥gica mejorada para m√∫ltiples usuarios:
                                // 1. Si el cambio local es muy reciente (< 500ms), protegerlo (evitar sobrescritura inmediata)
                                // 2. Si el cambio local es reciente pero no muy reciente (500ms - 1.5s), 
                                //    solo actualizar si no estamos sincronizando (evitar conflictos durante guardado)
                                // 3. Si el cambio local es antiguo (> 1.5s), siempre actualizar (permitir cambios de otros usuarios)
                                const isVeryRecentChange = timeSinceLastChange < 500;
                                const isRecentChange = timeSinceLastChange < 1500;
                                const shouldProtect = isVeryRecentChange || (isRecentChange && isSyncing);

                                if (!shouldProtect) {
                                    // Actualizar el estado desde Firebase
                                    existingAxie.classList.remove('banned', 'picked');
                                    if (newRemoteStatus === 'banned') {
                                        existingAxie.classList.add('banned');
                                    } else if (newRemoteStatus === 'picked') {
                                        existingAxie.classList.add('picked');
                                    }
                                    // Actualizar el timestamp para reflejar que aceptamos el cambio remoto
                                    existingAxie.dataset.lastStatusChange = Date.now().toString();
                                } else {
                                    // Si el cambio local es muy reciente, ignorar la actualizaci√≥n remota
                                    // para evitar que sobrescriba el cambio del usuario actual
                                    // (solo en consola si es muy reciente para debugging)
                                    if (isVeryRecentChange) {
                                        console.log(`üõ°Ô∏è Protegiendo cambio local muy reciente (< 500ms) para axie ${axieId}`);
                                    }
                                }
                            }
                        }
                    });
                }
            });

            const newTeamIds = newTeams.map(t => String(t.id !== undefined ? t.id : t.name));
            currentTeams.forEach(teamDiv => {
                const teamId = teamDiv.dataset.teamId;
                if (!newTeamIds.includes(teamId)) {
                    teamDiv.remove();
                }
            });

            if (container.children.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay equipos guardados. ¬°Crea tu primer equipo arriba!</div>';
            }
        }

        function createTeamElement(team, teamId) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-card';
            teamDiv.dataset.teamId = teamId;

            const header = document.createElement('div');
            header.className = 'team-header';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'team-name';
            nameSpan.textContent = team.name;
            nameSpan.title = 'Haz doble clic para editar';
            nameSpan.addEventListener('dblclick', () => editTeamName(teamId));

            let lastTap = 0;
            nameSpan.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    editTeamName(teamId);
                }
                lastTap = currentTime;
            });

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'team-buttons';

            const moveUpBtn = document.createElement('button');
            moveUpBtn.innerHTML = '‚¨Ü';
            moveUpBtn.title = 'Mover arriba';
            moveUpBtn.onclick = () => moverParaArriba(teamId);

            const moveDownBtn = document.createElement('button');
            moveDownBtn.innerHTML = '‚¨á';
            moveDownBtn.title = 'Mover abajo';
            moveDownBtn.onclick = () => moverParaAbajo(teamId);

            const clearBtn = document.createElement('button');
            clearBtn.className = 'clear-axies-btn';
            clearBtn.innerHTML = 'üóëÔ∏è Limpiar';
            clearBtn.onclick = () => clearAllAxies(teamId);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'üóëÔ∏è Eliminar';
            deleteBtn.onclick = () => deleteTeam(teamId);

            buttonsContainer.appendChild(moveUpBtn);
            buttonsContainer.appendChild(moveDownBtn);
            buttonsContainer.appendChild(clearBtn);
            buttonsContainer.appendChild(deleteBtn);

            header.appendChild(nameSpan);
            header.appendChild(buttonsContainer);
            header.style.pointerEvents = 'auto';
            teamDiv.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'axie-grid';

            team.axies.forEach(axie => {
                if (axie.id) {
                    addAxieToGrid(axie.id, grid, axie.status || '', false);
                }
            });

            teamDiv.appendChild(grid);

            const addAxieDiv = document.createElement('div');
            addAxieDiv.className = 'add-axie';
            addAxieDiv.innerHTML = `
        <input type="text" placeholder="ID Axie o IDs separados por coma" id="axieInput-${teamId}" onkeypress="if(event.key==='Enter') addAxie(${teamId})">
        <button onclick="addAxie(${teamId})">‚ûï Agregar Axie(s)</button>
        <button class="copy-ids-btn" onclick="copyAllAxieIds(${teamId})">üìã Copiar todas las IDs</button>
    `;
            teamDiv.appendChild(addAxieDiv);

            return teamDiv;
        }

        function moverParaArriba(teamId) {
            if (isSyncing) return; // No mover si estamos sincronizando

            const teamCard = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (!teamCard) return;

            const prevTeam = teamCard.previousElementSibling;
            if (!prevTeam || !prevTeam.classList.contains('team-card')) {
                return; // Ya est√° en la parte superior
            }

            // Mover el equipo hacia arriba en el DOM
            teamCard.parentNode.insertBefore(teamCard, prevTeam);

            // Guardar inmediatamente en Firebase
            actualizarOrdenEnFirebase();
        }

        function moverParaAbajo(teamId) {
            if (isSyncing) return; // No mover si estamos sincronizando

            const teamCard = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (!teamCard) return;

            const nextTeam = teamCard.nextElementSibling;
            if (!nextTeam || !nextTeam.classList.contains('team-card')) {
                return; // Ya est√° en la parte inferior
            }

            // Mover el equipo hacia abajo en el DOM
            const afterNext = nextTeam.nextElementSibling;
            if (afterNext) {
                teamCard.parentNode.insertBefore(teamCard, afterNext);
            } else {
                // Si es el √∫ltimo, mover al final
                teamCard.parentNode.appendChild(teamCard);
            }

            // Guardar inmediatamente en Firebase
            actualizarOrdenEnFirebase();
        }

        function actualizarOrdenEnFirebase() {
            if (isSyncing) return; // Evitar loop infinito

            const container = document.getElementById('teamsContainer');
            if (!container) return;

            const teams = [];
            const teamCards = Array.from(container.querySelectorAll('.team-card'));

            teamCards.forEach((teamCard, index) => {
                const teamId = teamCard.dataset.teamId;
                const nameElement = teamCard.querySelector('.team-name');
                if (!nameElement) return;

                const name = nameElement.innerText || nameElement.textContent || '';
                const axies = [];
                const axieContainers = teamCard.querySelectorAll('.axie-container');
                axieContainers.forEach(axieDiv => {
                    const id = axieDiv.dataset.axieId;
                    if (!id) return;
                    let status = '';
                    if (axieDiv.classList.contains('banned')) status = 'banned';
                    else if (axieDiv.classList.contains('picked')) status = 'picked';
                    axies.push({ id: String(id), status: status });
                });
                teams.push({ id: String(teamId), name: name, axies: axies });
            });

            // Guardar en localStorage
            localStorage.setItem('axieTeams', JSON.stringify(teams));

            // Guardar en Firebase si est√° configurado
            if (isFirebaseConfigured && db) {
                isSyncing = true;
                updateConnectionStatus('syncing');

                db.ref(DB_PATH).set(teams)
                    .then(() => {
                        lastSaveTime = Date.now();
                        setTimeout(() => {
                            isSyncing = false;
                            updateConnectionStatus('connected');
                        }, 200);
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al guardar orden en Firebase:', error);
                        isSyncing = false;
                        updateConnectionStatus('connected');
                    });
            }
        }

        function renderTeams(teams, isRealtimeUpdate = false) {
            const container = document.getElementById('teamsContainer');

            if (!teams || teams.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay equipos guardados. ¬°Crea tu primer equipo arriba!</div>';
                return;
            }

            container.innerHTML = '';
            teamCount = 0;

            teams.forEach(team => {
                const currentTeamId = team.id !== undefined ? team.id : teamCount;
                const teamDiv = createTeamElement(team, currentTeamId);
                container.appendChild(teamDiv);
                teamCount = Math.max(teamCount, parseInt(currentTeamId) + 1);
            });
        }

        function loadTeams() {
            if (isFirebaseConfigured && db) {
                updateConnectionStatus('syncing');

                db.ref(DB_PATH).once('value')
                    .then((snapshot) => {
                        const teams = snapshot.val();
                        if (teams) {
                            renderTeams(teams);
                            localStorage.setItem('axieTeams', JSON.stringify(teams));
                        } else {
                            const saved = localStorage.getItem('axieTeams');
                            if (saved) {
                                renderTeams(JSON.parse(saved));
                            } else {
                                renderTeams([]);
                            }
                        }
                        updateConnectionStatus('connected');

                        setupRealtimeListener();
                    })
                    .catch((error) => {
                        console.error('Error al cargar desde Firebase:', error);
                        const saved = localStorage.getItem('axieTeams');
                        if (saved) {
                            renderTeams(JSON.parse(saved));
                        } else {
                            renderTeams([]);
                        }
                        updateConnectionStatus('disconnected');
                    });
            } else {
                const saved = localStorage.getItem('axieTeams');
                if (saved) {
                    renderTeams(JSON.parse(saved));
                } else {
                    renderTeams([]);
                }
            }
        }

        function setupRealtimeListener() {
            if (!isFirebaseConfigured || !db) {
                console.warn('‚ö†Ô∏è No se puede configurar el listener: Firebase no est√° configurado');
                return;
            }

            if (realtimeListener) {
                db.ref(DB_PATH).off('value', realtimeListener);
            }

            console.log('üîÑ Configurando listener en tiempo real...');

            let lastUpdateTime = Date.now();
            let updateTimeout = null;

            realtimeListener = db.ref(DB_PATH).on('value', (snapshot) => {
                // Verificar al inicio para evitar procesamiento innecesario
                if (isSyncing) {
                    return;
                }

                const teams = snapshot.val();
                const now = Date.now();

                // Evitar actualizaciones muy frecuentes
                if (now - lastUpdateTime < 300) {
                    return;
                }

                const timeSinceLastSave = now - lastSaveTime;

                // Si acabamos de guardar muy recientemente (< 200ms), esperar un poco
                // Esto evita que nuestra propia actualizaci√≥n nos llegue de vuelta
                // Pero permitir actualizaciones de otros usuarios despu√©s de 200ms
                if (timeSinceLastSave < 200 && isSyncing) {
                    return;
                }

                const normalizeData = (data) => {
                    if (!data) return '';
                    const normalized = (data || []).map((team, index) => ({
                        index: index,
                        id: String(team.id || ''),
                        name: String(team.name || ''),
                        axies: (team.axies || []).map(axie => ({
                            id: String(axie.id || ''),
                            status: String(axie.status || '')
                        })).sort((a, b) => a.id.localeCompare(b.id))
                    }));
                    return JSON.stringify(normalized);
                };

                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    // Verificar nuevamente antes de procesar
                    if (isSyncing) {
                        return;
                    }

                    // Si acabamos de guardar muy recientemente, esperar un poco m√°s
                    // pero permitir actualizaciones de otros usuarios despu√©s de 200ms
                    if (timeSinceLastSave < 200) {
                        return;
                    }

                    const currentData = normalizeData(getTeamsData());
                    const newData = normalizeData(teams);

                    if (currentData !== newData && newData !== '') {
                        console.log('üîÑ Actualizaci√≥n en tiempo real detectada');
                        // Establecer flag ANTES de procesar para evitar loops
                        isSyncing = true;
                        lastUpdateTime = now;
                        pendingSave = false;

                        // Guardar posici√≥n de scroll antes de actualizar
                        const scrollY = window.scrollY;

                        // Procesar la actualizaci√≥n
                        updateTeamsIncremental(teams || [], true);
                        localStorage.setItem('axieTeams', JSON.stringify(teams || []));

                        // Forzar actualizaci√≥n del DOM
                        void document.body.offsetHeight; // Trigger reflow

                        // Restaurar posici√≥n de scroll despu√©s de actualizar
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                window.scrollTo(0, scrollY);
                            }, 50);
                        });

                        // Permitir nuevas actualizaciones despu√©s de un tiempo m√°s corto
                        // para permitir actualizaciones m√°s r√°pidas entre m√∫ltiples usuarios
                        setTimeout(() => {
                            isSyncing = false;
                            console.log('‚úÖ Sincronizaci√≥n completada, listo para nuevas actualizaciones');
                        }, 200);
                    }
                }, 200);
            }, (error) => {
                console.error('‚ùå Error en el listener de Firebase:', error);
                updateConnectionStatus('disconnected');
            });

            console.log('‚úÖ Listener en tiempo real configurado correctamente');
        }

        function addTeam() {
            const teamName = document.getElementById('teamNameInput').value.trim();
            const axieIdsRaw = document.getElementById('axieIdsInput').value.trim();
            if (!teamName) {
                alert("‚ö†Ô∏è Agrega un nombre de equipo");
                return;
            }

            const axieIds = axieIdsRaw ? axieIdsRaw.split(/[\s,]+/).filter(id => id.trim()) : [];
            const container = document.getElementById('teamsContainer');

            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-card';
            teamDiv.dataset.teamId = teamCount;

            const header = document.createElement('div');
            header.className = 'team-header';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'team-name';
            nameSpan.textContent = teamName;
            nameSpan.title = 'Haz doble clic para editar';
            nameSpan.addEventListener('dblclick', () => editTeamName(teamCount));

            let lastTap = 0;
            nameSpan.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    editTeamName(teamCount);
                }
                lastTap = currentTime;
            });

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'team-buttons';

            const moveUpBtn = document.createElement('button');
            moveUpBtn.innerHTML = '‚¨Ü';
            moveUpBtn.title = 'Mover arriba';
            moveUpBtn.onclick = () => moverParaArriba(teamCount);

            const moveDownBtn = document.createElement('button');
            moveDownBtn.innerHTML = '‚¨á';
            moveDownBtn.title = 'Mover abajo';
            moveDownBtn.onclick = () => moverParaAbajo(teamCount);

            const clearBtn = document.createElement('button');
            clearBtn.className = 'clear-axies-btn';
            clearBtn.innerHTML = 'üóëÔ∏è Limpiar';
            clearBtn.onclick = () => clearAllAxies(teamCount);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'üóëÔ∏è Eliminar';
            deleteBtn.onclick = () => deleteTeam(teamCount);

            buttonsContainer.appendChild(moveUpBtn);
            buttonsContainer.appendChild(moveDownBtn);
            buttonsContainer.appendChild(clearBtn);
            buttonsContainer.appendChild(deleteBtn);

            header.appendChild(nameSpan);
            header.appendChild(buttonsContainer);
            teamDiv.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'axie-grid';

            axieIds.forEach(id => {
                const trimmedId = id.trim();
                if (trimmedId) {
                    addAxieToGrid(trimmedId, grid);
                }
            });

            teamDiv.appendChild(grid);

            const addAxieDiv = document.createElement('div');
            addAxieDiv.className = 'add-axie';
            addAxieDiv.innerHTML = `
        <input type="text" placeholder="ID Axie o IDs separados por coma" id="axieInput-${teamCount}" onkeypress="if(event.key==='Enter') addAxie(${teamCount})">
        <button onclick="addAxie(${teamCount})">‚ûï Agregar Axie(s)</button>
        <button class="copy-ids-btn" onclick="copyAllAxieIds(${teamCount})">üìã Copiar todas las IDs</button>
    `;
            teamDiv.appendChild(addAxieDiv);

            container.appendChild(teamDiv);

            teamCount++;
            document.getElementById('teamNameInput').value = '';
            document.getElementById('axieIdsInput').value = '';

            saveTeams();
        }

        function addAxieToGrid(id, grid, status = '', shouldSave = true) {

            const existingAxies = Array.from(grid.querySelectorAll('.axie-container'));
            if (existingAxies.some(axie => axie.dataset.axieId === id)) {
                if (shouldSave) alert("‚ö†Ô∏è Este Axie ya est√° en el equipo");
                return false;
            }

            const axieDiv = document.createElement('div');
            axieDiv.className = 'axie-container';
            axieDiv.dataset.axieId = id;
            if (status) axieDiv.classList.add(status);

            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'axie-image-wrapper';

            const img = document.createElement('img');
            img.src = `https://axiecdn.axieinfinity.com/axies/${id}/axie/axie-full-transparent.png`;
            img.alt = `Axie ${id}`;
            img.className = 'loading';

            let imageValid = false;
            let validationTimeout = null;

            img.onload = () => {
                img.classList.remove('loading');
                img.classList.remove('error');
                imageValid = true;
                if (validationTimeout) clearTimeout(validationTimeout);
            };

            img.onerror = () => {
                const altImg = new Image();
                altImg.src = `https://assets.axieinfinity.com/axies/${id}/axie/axie-full-transparent.png`;
                altImg.onload = () => {
                    img.src = altImg.src;
                    img.classList.remove('loading');
                    img.classList.remove('error');
                    imageValid = true;
                    if (validationTimeout) clearTimeout(validationTimeout);
                };
                altImg.onerror = () => {
                    img.classList.remove('loading');
                    img.classList.add('error');
                    if (shouldSave) {
                        alert(`‚ö†Ô∏è ID inv√°lida: ${id}\nEl Axie con este ID no existe.`);
                    }
                    axieDiv.remove();
                    imageValid = false;
                    if (validationTimeout) clearTimeout(validationTimeout);
                };
            };

            validationTimeout = setTimeout(() => {
                if (!imageValid) {
                    if (shouldSave) {
                        alert(`‚ö†Ô∏è ID inv√°lida: ${id}\nNo se pudo cargar la imagen del Axie.`);
                    }
                    axieDiv.remove();
                }
            }, 5000);

            imageWrapper.appendChild(img);

            const idLabel = document.createElement('div');
            idLabel.className = 'axie-id-label';
            idLabel.textContent = `#${id}`;

            // Prevenir m√∫ltiples clics muy r√°pidos usando atributo de datos
            // Reducido porque la cola de guardado maneja el orden
            const CLICK_DEBOUNCE = 100; // ms

            axieDiv.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const now = Date.now();
                const lastClickTime = axieDiv.dataset.lastClickTime ? parseInt(axieDiv.dataset.lastClickTime) : 0;

                // Ignorar clics muy r√°pidos (debounce)
                if (now - lastClickTime < CLICK_DEBOUNCE) {
                    return;
                }
                axieDiv.dataset.lastClickTime = now.toString();

                axieDiv.blur();
                if (document.activeElement) {
                    document.activeElement.blur();
                }

                if (document.activeElement && document.activeElement !== document.body) {
                    document.activeElement.blur();
                }

                const wasBanned = axieDiv.classList.contains('banned');
                const wasPicked = axieDiv.classList.contains('picked');

                // Actualizar estado inmediatamente
                let newStatus = '';
                if (wasBanned) {
                    axieDiv.classList.remove('banned');
                    axieDiv.classList.add('picked');
                    newStatus = 'picked';
                } else if (wasPicked) {
                    axieDiv.classList.remove('picked');
                    newStatus = '';
                } else {
                    axieDiv.classList.add('banned');
                    newStatus = 'banned';
                }

                axieDiv.style.transform = '';
                axieDiv.style.webkitTransform = '';

                // Forzar actualizaci√≥n del DOM antes de guardar
                void axieDiv.offsetHeight; // Trigger reflow

                // Marcar el tiempo del cambio ANTES de guardar
                const changeTime = Date.now();
                axieDiv.dataset.lastStatusChange = changeTime.toString();

                // Agregar un delay m√°s largo para asegurar que el DOM se actualice completamente
                // y que el estado se refleje correctamente antes de guardar
                // Esto es especialmente importante para clics r√°pidos
                setTimeout(() => {
                    // Doble verificaci√≥n: leer el estado actual del DOM para asegurar que es correcto
                    const currentBanned = axieDiv.classList.contains('banned');
                    const currentPicked = axieDiv.classList.contains('picked');
                    const actualStatus = currentBanned ? 'banned' : (currentPicked ? 'picked' : '');

                    // Verificar que el estado actual coincide con el esperado
                    if (actualStatus === newStatus || (newStatus === '' && actualStatus === '')) {
                        lastSaveTime = Date.now();
                        // Usar requestAnimationFrame para asegurar que el DOM est√© completamente actualizado
                        requestAnimationFrame(() => {
                            saveTeams(true);
                        });
                    } else {
                        // Si hay discrepancia, esperar un poco m√°s y reintentar
                        setTimeout(() => {
                            lastSaveTime = Date.now();
                            saveTeams(true);
                        }, 100);
                    }
                }, 400); // Delay de 400ms para asegurar que el DOM se actualice completamente

                setTimeout(() => {
                    axieDiv.blur();
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                    if (document.body) {
                        document.body.focus();
                    }
                }, 50);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'axie-delete';
            deleteBtn.innerText = '√ó';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                axieDiv.style.transition = 'all 0.3s ease';
                axieDiv.style.transform = 'scale(0) rotate(180deg)';
                axieDiv.style.opacity = '0';
                setTimeout(() => {
                    axieDiv.remove();
                    // Forzar actualizaci√≥n del DOM antes de guardar
                    void grid.offsetHeight; // Trigger reflow
                    // Guardar inmediatamente para que se propague en tiempo real
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            saveTeams(true);
                        }, 100);
                    });
                }, 300);
            };

            imageWrapper.appendChild(img);
            axieDiv.appendChild(imageWrapper);
            axieDiv.appendChild(idLabel);
            axieDiv.appendChild(deleteBtn);
            grid.appendChild(axieDiv);

            return true;
        }

        function addAxie(teamId) {
            const input = document.getElementById(`axieInput-${teamId}`);
            const idsRaw = input.value.trim();
            if (!idsRaw) return;

            const ids = idsRaw.split(/[\s,]+/).filter(id => id.trim());
            if (ids.length === 0) return;

            const teamDiv = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            const grid = teamDiv.querySelector('.axie-grid');

            const validIds = ids.filter(id => id.trim());
            let addedCount = 0;
            let validCount = 0;

            validIds.forEach((id, index) => {
                const trimmedId = id.trim();
                setTimeout(() => {
                    const result = addAxieToGrid(trimmedId, grid, '', false);
                    if (result !== false) {
                        validCount++;
                    }
                    addedCount++;

                    // Cuando todos los axies se hayan agregado, guardar
                    if (addedCount === validIds.length) {
                        // Forzar actualizaci√≥n del DOM antes de guardar
                        void grid.offsetHeight; // Trigger reflow
                        // Esperar un poco m√°s para asegurar que todas las im√°genes se hayan agregado al DOM
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                if (validCount > 0) {
                                    // Guardar inmediatamente para que se propague en tiempo real
                                    saveTeams(true);
                                }
                            }, 200);
                        });
                    }
                }, index * 30);
            });

            input.value = '';
        }

        function copyAllAxieIds(teamId) {
            const teamDiv = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (!teamDiv) return;

            const grid = teamDiv.querySelector('.axie-grid');
            if (!grid) return;

            const axies = Array.from(grid.querySelectorAll('.axie-container'));
            if (axies.length === 0) {
                alert('Este equipo no tiene axies para copiar');
                return;
            }

            const ids = axies.map(axie => axie.dataset.axieId).filter(id => id);
            const idsString = ids.join(', ');

            const updateButton = (button) => {
                const originalText = button.innerHTML;
                button.innerHTML = '‚úì Copiado!';
                button.style.background = 'rgba(46, 213, 115, 0.2)';
                button.style.borderColor = 'rgba(46, 213, 115, 0.5)';
                button.style.color = '#2ed573';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.style.borderColor = '';
                    button.style.color = '';
                }, 2000);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(idsString).then(() => {
                    const button = document.querySelector(`button.copy-ids-btn[onclick*="${teamId}"]`);
                    if (button) updateButton(button);
                }).catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = idsString;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    const button = document.querySelector(`button.copy-ids-btn[onclick*="${teamId}"]`);
                    if (button) updateButton(button);
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = idsString;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                const button = document.querySelector(`button.copy-ids-btn[onclick*="${teamId}"]`);
                if (button) updateButton(button);
            }
        }

        function editTeamName(teamId) {
            const teamDiv = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (!teamDiv) return;

            const nameSpan = teamDiv.querySelector('.team-name');
            if (!nameSpan) return;

            const currentName = nameSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'team-name-input';
            input.value = currentName;

            nameSpan.style.display = 'none';
            nameSpan.parentElement.insertBefore(input, nameSpan);
            input.focus();
            input.select();

            const saveName = () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    nameSpan.textContent = newName;
                    saveTeams();
                }
                input.remove();
                nameSpan.style.display = '';
            };

            input.addEventListener('blur', saveName);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveName();
                } else if (e.key === 'Escape') {
                    input.remove();
                    nameSpan.style.display = '';
                }
            });
        }

        function clearAllAxies(teamId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODOS los axies de este equipo?')) {
                return;
            }

            const teamDiv = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (!teamDiv) return;

            const grid = teamDiv.querySelector('.axie-grid');
            if (!grid) return;

            const axies = grid.querySelectorAll('.axie-container');
            if (axies.length === 0) {
                alert('Este equipo no tiene axies para eliminar');
                return;
            }

            axies.forEach(axie => {
                axie.style.transition = 'all 0.3s ease';
                axie.style.transform = 'scale(0) rotate(180deg)';
                axie.style.opacity = '0';
            });

            setTimeout(() => {
                axies.forEach(axie => axie.remove());
                // Forzar actualizaci√≥n del DOM antes de guardar
                void grid.offsetHeight; // Trigger reflow
                // Guardar inmediatamente despu√©s de limpiar
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        saveTeams(true);
                    }, 100);
                });
            }, 300);
        }

        function deleteTeam(teamId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este equipo?')) {
                return;
            }
            const container = document.getElementById('teamsContainer');
            const teamDiv = container.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (teamDiv) {
                teamDiv.style.transition = 'all 0.4s ease';
                teamDiv.style.transform = 'translateX(-100%)';
                teamDiv.style.opacity = '0';
                setTimeout(() => {
                    teamDiv.remove();
                    setTimeout(() => {
                        saveTeams();
                    }, 100);
                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="empty-state">No hay equipos guardados. ¬°Crea tu primer equipo arriba!</div>';
                    }
                }, 400);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    checkLogin();
                }, 200);
            });
        } else {
            setTimeout(() => {
                checkLogin();
            }, 200);
        }
    </script>

</body>

</html>
